#include <LedControl.h>


//2 FILAS DE MATRICES DE 3 MATRICES
#define fila1_data_pin 24
#define fila1_load_pin 23
#define fila1_clock_pin 22

#define fila2_data_pin 27
#define fila2_load_pin 26
#define fila2_clock_pin 25

const int num_displays = 3;

LedControl fila1 = LedControl(fila1_data_pin, fila1_clock_pin, fila1_load_pin, num_displays);
LedControl fila2 = LedControl(fila2_data_pin, fila2_clock_pin, fila2_load_pin, num_displays);

String mensaje = "";

const static byte simbolos_altura10[96][8] = {
  {B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000}, //
  {B00000000, B00011000, B00011000, B00011000, B00011000, B00000000, B00011000, B00011000}, // !
  {B00000000, B01100110, B01100110, B01100110, B00000000, B00000000, B00000000, B00000000}, // "
  {B00000000, B01100110, B01100110, B11111110, B01100110, B11111110, B01100110, B01100110}, // #
  {B00000000, B00011000, B00111100, B01000100, B00111000, B00001100, B10001100, B01111000}, // $
  {B00000000, B11000110, B11001100, B00011000, B00110000, B01100000, B11000110, B11000110}, // %
  {B00000000, B00111000, B01000100, B01000100, B00111000, B01011000, B10001100, B01110110}, // &
  {B00000000, B00011000, B00011000, B00011000, B00000000, B00000000, B00000000, B00000000}, // '
  {B00000000, B00001100, B00011000, B00110000, B00110000, B00110000, B00011000, B00001100}, // (
  {B00000000, B01100000, B00011000, B00001100, B00001100, B00001100, B00011000, B01100000}, // )
  {B00000000, B00000000, B00000000, B01000100, B00111000, B11111110, B00111000, B01000100}, // *
  {B00000000, B00000000, B00011000, B00011000, B01111110, B00011000, B00011000, B00000000}, // +
  {B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00011000, B00011000}, // ,
  {B00000000, B00000000, B00000000, B00000000, B01111110, B00000000, B00000000, B00000000}, // -
  {B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00011000, B00011000}, // .
  {B00000000, B00000010, B00000110, B00001100, B00011000, B00110000, B01100000, B11000000}, // /
  {B00000000, B00111000, B01000100, B01000100, B01000100, B01000100, B01000100, B00111000}, // 0
  {B00000000, B00011000, B00111000, B00011000, B00011000, B00011000, B00011000, B00111100}, // 1
  {B00000000, B00111000, B01000100, B00000100, B00011000, B00110000, B01000000, B01111100}, // 2
  {B00000000, B00111000, B01000100, B00000100, B00011000, B00000100, B01000100, B00111000}, // 3
  {B00000000, B00001100, B00011100, B00101100, B01001100, B01111110, B00001100, B00001100}, // 4
  {B00000000, B01111100, B01000000, B01111000, B00000100, B00000100, B01000100, B00111000}, // 5
  {B00000000, B00111000, B01000100, B01000000, B01111000, B01000100, B01000100, B00111000}, // 6
  {B00000000, B01111100, B01000100, B00000100, B00001000, B00011000, B00011000, B00011000}, // 7
  {B00000000, B00111000, B01000100, B01000100, B00111000, B01000100, B01000100, B00111000}, // 8
  {B00000000, B00111000, B01000100, B01000100, B00111100, B00000100, B01000100, B00111000}, // 9
  {B00000000, B00000000, B00011000, B00011000, B00000000, B00000000, B00011000, B00011000}, // :
  {B00000000, B00000000, B00011000, B00011000, B00000000, B00000000, B00011000, B00011000}, // ;
  {B00000000, B00000100, B00001100, B00011000, B00110000, B00011000, B00001100, B00000100}, // <
  {B00000000, B00000000, B00000000, B01111110, B00000000, B01111110, B00000000, B00000000}, // =
  {B00000000, B01000000, B01100000, B00011000, B00001100, B00011000, B01100000, B01000000}, // >
  {B00000000, B00111000, B01000100, B00000100, B00011000, B00011000, B00000000, B00011000}, // ?
  {B00000000, B00111000, B01000100, B01011100, B01011100, B01011100, B01000000, B00111100}, // @
  {B00000000, B00011000, B00111100, B01000100, B01000100, B01111100, B01000100, B01000100}, // A
  {B00000000, B01111000, B01000100, B01000100, B01111000, B01000100, B01000100, B01111000}, // B
  {B00000000, B00111000, B01000100, B01000000, B01000000, B01000000, B01000100, B00111000}, // C
  {B00000000, B01111000, B01000100, B01000100, B01000100, B01000100, B01000100, B01111000}, // D
  {B00000000, B01111100, B01000000, B01000000, B01111000, B01000000, B01000000, B01111100}, // E
  {B00000000, B01111100, B01000000, B01000000, B01111000, B01000000, B01000000, B01000000}, // F
  {B00000000, B00111000, B01000100, B01000000, B01011100, B01000100, B01000100, B00111000}, // G
  {B00000000, B01000100, B01000100, B01000100, B01111100, B01000100, B01000100, B01000100}, // H
  {B00000000, B00111000, B00011000, B00011000, B00011000, B00011000, B00011000, B00111000}, // I
  {B00000000, B00011100, B00001100, B00001100, B00001100, B01001100, B01001100, B00111000}, // J
  {B00000000, B01000100, B01001000, B01010000, B01100000, B01010000, B01001000, B01000100}, // K
  {B00000000, B01000000, B01000000, B01000000, B01000000, B01000000, B01000000, B01111100}, // L
  {B00000000, B01000100, B01101100, B01010100, B01000100, B01000100, B01000100, B01000100}, // M
  {B00000000, B01000100, B01100100, B01010100, B01001100, B01000100, B01000100, B01000100}, // N
  {B00000000, B00111000, B01000100, B01000100, B01000100, B01000100, B01000100, B00111000}, // O
  {B00000000, B01111000, B01000100, B01000100, B01111000, B01000000, B01000000, B01000000}, // P
  {B00000000, B00111000, B01000100, B01000100, B01000100, B01010100, B01001100, B00111000}, // Q
  {B00000000, B01111000, B01000100, B01000100, B01111000, B01010000, B01001000, B01000100}, // R
  {B00000000, B00111000, B01000100, B01000000, B00111000, B00000100, B01000100, B00111000}, // S
  {B00000000, B01111100, B00101000, B00101000, B00101000, B00101000, B00101000, B00101000}, // T
  {B00000000, B01000100, B01000100, B01000100, B01000100, B01000100, B01000100, B00111000}, // U
  {B00000000, B01000100, B01000100, B01000100, B01000100, B01000100, B00101000, B00010000}, // V
  {B00000000, B01000100, B01000100, B01000100, B01000100, B01010100, B01101100, B01000100}, // W
  {B00000000, B01000100, B01000100, B00101000, B00010000, B00101000, B01000100, B01000100}, // X
  {B00000000, B01000100, B01000100, B01000100, B00111000, B00010000, B00010000, B00010000}, // Y
  {B00000000, B01111100, B00000100, B00001000, B00010000, B00100000, B01000000, B01111100}, // Z
  {B00000000, B00111000, B00100000, B00100000, B00100000, B00100000, B00100000, B00111000}, // [
  {B00000000, B01000000, B00100000, B00010000, B00001000, B00000100, B00000010, B00000001}, // "\"
  {B00000000, B00111000, B00001000, B00001000, B00001000, B00001000, B00001000, B00111000}, // ]
  {B00000000, B00010000, B00101000, B01000100, B00000000, B00000000, B00000000, B00000000}, // ^
  {B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B01111100}, // _
  {B00000000, B00011000, B00011000, B00001100, B00000000, B00000000, B00000000, B00000000}, // `
  {B00000000, B00000000, B00111000, B00000100, B00111100, B01000100, B01000100, B00111100}, // a
  {B00000000, B01000000, B01000000, B01111000, B01000100, B01000100, B01000100, B01111000}, // b
  {B00000000, B00000000, B00111000, B01000100, B01000000, B01000000, B01000100, B00111000}, // c
  {B00000000, B00000100, B00000100, B00111100, B01000100, B01000100, B01000100, B00111100}, // d
  {B00000000, B00000000, B00111000, B01000100, B01111100, B01000000, B01000100, B00111000}, // e
  {B00000000, B00011100, B00100100, B00100000, B01111000, B00100000, B00100000, B00100000}, // f
  {B00000000, B00111100, B01000100, B01000100, B00111100, B00000100, B01000100, B00111000}, // g
  {B00000000, B01000000, B01000000, B01111000, B01000100, B01000100, B01000100, B01000100}, // h
  {B00000000, B00010000, B00000000, B00110000, B00010000, B00010000, B00010000, B00111000}, // i
  {B00000000, B00001000, B00000000, B00011000, B00001000, B00001000, B01001000, B00110000}, // j
  {B00000000, B01000000, B01000000, B01001000, B01010000, B01100000, B01010000, B01001000}, // k
  {B00000000, B00110000, B00010000, B00010000, B00010000, B00010000, B00010000, B00111000}, // l
  {B00000000, B00000000, B01101100, B01010100, B01010100, B01010100, B01010100, B01010100}, // m
  {B00000000, B00000000, B01111000, B01000100, B01000100, B01000100, B01000100, B01000100}, // n
  {B00000000, B00000000, B00111000, B01000100, B01000100, B01000100, B01000100, B00111000}, // o
  {B00000000, B01111000, B01000100, B01000100, B01111000, B01000000, B01000000, B01000000}, // p
  {B00000000, B00111100, B01000100, B01000100, B00111100, B00000100, B00000100, B00000100}, // q
  {B00000000, B00000000, B01111000, B01000100, B01000000, B01000000, B01000000, B01000000}, // r
  {B00000000, B00000000, B00111100, B01000000, B00111000, B00000100, B01000100, B00111000}, // s
  {B00000000, B00100000, B00100000, B01111000, B00100000, B00100000, B00100100, B00011000}, // t
  {B00000000, B00000000, B01000100, B01000100, B01000100, B01000100, B01000100, B00111100}, // u
  {B00000000, B00000000, B01000100, B01000100, B01000100, B01000100, B00101000, B00010000}, // v
  {B00000000, B00000000, B01000100, B01000100, B01000100, B01010100, B01101100, B01000100}, // w
  {B00000000, B00000000, B01000100, B01000100, B00101000, B00010000, B00101000, B01000100}, // x
  {B00000000, B01000100, B01000100, B01000100, B00111100, B00000100, B01000100, B00111000}, // y
  {B00000000, B00000000, B01111100, B00001000, B00010000, B00100000, B01000000, B01111100}, // z
  {B00000000, B00011000, B00100000, B00100000, B01000000, B00100000, B00100000, B00011000}, // {
  {B00000000, B00010000, B00010000, B00010000, B00010000, B00010000, B00010000, B00010000}, // |
  {B00000000, B01100000, B00010000, B00010000, B00001000, B00010000, B00010000, B01100000}, // }
  {B00000000, B00000000, B00000000, B00000000, B01110111, B11011100, B00000000, B00000000} // ~


};

void setup() {
  // put your setup code here, to run once:
  Serial.begin(9600);
  Serial.println("Setup Terminado");

  for (int disp = 0; disp < 3; disp++) {
    fila1.shutdown(disp, false);
    fila1.setIntensity(disp, 8);
    fila1.clearDisplay(disp);
    
    fila2.shutdown(disp, false);
    fila2.setIntensity(disp, 8); 
    fila2.clearDisplay(disp);
  }

}

void loop() {
  // put your main code here, to run repeatedly:
  checkIncommingData();

}

void checkIncommingData() {
  if (Serial.available() > 0) {
    mensaje = "";
    while (Serial.available() > 0) {
      Serial.println("Dato recibido");
      mensaje += char(Serial.read());
    }
  }

  char arr[mensaje.length() + 1];
  strcpy(arr, mensaje.c_str());


  // updateMatrix("hola");
  scrollMsg(arr, 25);
}

void updateMatrix(String frase) {
  String mensaje = frase;
  int largo = mensaje.length();
  for (int i = 0; i < largo; i++) {
    char letra = mensaje.charAt(i);
    int ascii = letra;
    if (ascii >= 32 && ascii <= 126) {
      int pos = ascii - 32;


      for (int fila = 0; fila < 8; fila++) {
        fila1.setRow(0, fila, simbolos_altura10[pos][fila]);
        fila2.setRow(0, fila, simbolos_altura10[pos][fila]);
      }
      delay(1000);


    }
  }


}

void escribirFrase(const char* frase, int posicion) {
  for (size_t i = 0; i < strlen(frase); i++) {
    escribirCaracter(frase[i], (i * 8) + posicion);
    if(Serial.available() > 0){
      break;
    }
  }
}

void escribirCaracter(char caracter , int posicion) {
  int posicion_caracter;

  uint8_t codigocaracter[] = {
    B00000000, B00001000, B00101010, B00011100, B01110111, B00011100, B00101010, B00001000
  };

  if (caracter >= 32 && caracter <= 126) {
    posicion_caracter = caracter - 32;
    for (int i = 0; i < 8; i++) {
      codigocaracter[i] = simbolos_altura10[posicion_caracter][i];
    }
  }
  else {
    for (int i = 0; i < 8; i++) {
      codigocaracter[i] = simbolos_altura10[95][i];
    }
  }

  // rotacion de 90 grados de caracter
  uint8_t temporal[8] = {0, 0, 0, 0, 0, 0, 0, 0};
  for (int i=0; i<8; i++){
    bitWrite(temporal[7], i, bitRead(codigocaracter[i], 0));
    bitWrite(temporal[6], i, bitRead(codigocaracter[i], 1));
    bitWrite(temporal[5], i, bitRead(codigocaracter[i], 2));
    bitWrite(temporal[4], i, bitRead(codigocaracter[i], 3));
    bitWrite(temporal[3], i, bitRead(codigocaracter[i], 4));
    bitWrite(temporal[2], i, bitRead(codigocaracter[i], 5));
    bitWrite(temporal[1], i, bitRead(codigocaracter[i], 6));
    bitWrite(temporal[0], i, bitRead(codigocaracter[i], 7));
  }
  memcpy(codigocaracter, temporal, sizeof(temporal[0])*8);

  for (int i = 0; i < 8; i++) {
    int address = 0;
    int posendisplay = posicion + i;
    while (posendisplay > 7) {
      address++;
      posendisplay -= 8;
    }
    if (address > fila1.getDeviceCount() - 1 )
      return;
    
    
    fila1.setColumn(address, posendisplay, codigocaracter[i]);
    fila2.setColumn(address, posendisplay, codigocaracter[i]);
    
    
    
  }
}

void scrollMsg(const char* mensaje, unsigned long frecuencia) {
  int inicio = 24;
  int pasos = strlen(mensaje) * 8;
  for (int i = inicio; i >= -pasos; i--) {
    escribirFrase(mensaje, i);
    delay(frecuencia);
  }
}
